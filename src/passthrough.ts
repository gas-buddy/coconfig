import fs from 'fs';
import path from 'path';
import type { CoConfigEnvironment } from './types/index';

const packageJson = JSON.parse(fs.readFileSync(path.resolve(__dirname, '../package.json'), 'utf8'));

const header = `/**
 * This file is generated by coconfig. Do not edit it directly.
 * Instead, edit the coconfig.js or coconfig.ts file in your project root.
 *
 * See https://github.com/gas-buddy/coconfig for more information.
 * @version coconfig@${packageJson.version}
 */`;

export const headerMarker = 'This file is generated by coconfig. Do not edit it directly';

function configReference(pathOrModule: string, packagePath: string) {
  if (fs.existsSync(pathOrModule)) {
    return `./${path.relative(path.dirname(packagePath), pathOrModule)}`;
  }
  // Else it's a node module
  return pathOrModule;
}

export function getFile(
  env: CoConfigEnvironment,
  key: string,
  filename: string,
) {
  const configRef = configReference(env.coconfigPath, env.packagePath);
  const noExt = configRef.startsWith('./') ? configRef.substring(0, configRef.length - path.extname(configRef).length) : configRef;
  if (path.extname(filename) === '.ts') {
    return `${header}import { '${key}' as config } from '${noExt}';
const resolved = typeof config === 'function' ? config() : config;
export default resolved;\n`;
  }
  if (path.extname(env.coconfigPath) === '.ts') {
    return `${header}
require('ts-node').register();
const config = require('${noExt}').default['${key}'].configuration;
module.exports = typeof config === 'function' ? config() : config;\n`;
  }
  return `${header}
const raw = require('${noExt}')['${key}'].configuration;

const config = typeof raw === 'function' ? raw() : raw;
module.exports = config;\n`;
}
