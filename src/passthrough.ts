import fs from 'fs';
import path from 'path';
import type { CoConfigEnvironment } from './types/index';

const packageJson = JSON.parse(fs.readFileSync(path.resolve(__dirname, '../package.json'), 'utf8'));

const header = `/**
 * This file is generated by coconfig. Do not edit it directly.
 * Instead, edit the coconfig.js or coconfig.ts file in your project root.
 *
 * See https://github.com/gas-buddy/coconfig for more information.
 * @version coconfig@${packageJson.version}
 */`;

export const headerMarker = 'This file is generated by coconfig. Do not edit it directly';

function configReference(pathOrModule: string, packagePath: string) {
  if (fs.existsSync(pathOrModule)) {
    return `./${path.relative(path.dirname(packagePath), pathOrModule)}`;
  }
  // Else it's a node module
  return pathOrModule;
}

function getModulePath(configRef: string) {
  // cjs needs full path
  if (configRef.startsWith('./') && path.extname(configRef).length === 3) {
    return configRef.substring(0, configRef.length - path.extname(configRef).length);
  }
  return configRef;
}

export function getFile(env: CoConfigEnvironment, key: string, filename: string) {
  const configRef = configReference(env.coconfigPath, env.packagePath);
  const ext = path.extname(filename);
  const isModule =
    (env.packageJson?.type === 'module' || /.m[jt]s/.test(ext)) && !/.c[jt]s/.test(ext);

  const modulePath = isModule ? configRef : getModulePath(configRef);

  const isTs = /\.[mc]?ts/.test(ext);

  const commonCode = `
const configItem = configModule.default || configModule.config || configModule;
const { configuration } = configItem && configItem['${key}'];
const resolved = typeof configuration === 'function' ? configuration() : configuration;
`;

  if (isModule && isTs) {
    return `${header}
import cjs from '${modulePath}';
import * as esmToCjs from '${modulePath}';

// eslint-disable-next-line @typescript-eslint/no-explicit-any
const configModule: any = cjs || esmToCjs;
${commonCode}
// eslint-disable-next-line import/no-default-export
export default resolved;\n`;
  }

  if (isModule) {
    return `${header}
import cjs from '${modulePath}';
import * as esmToCjs from '${modulePath}';

const configModule = cjs || esmToCjs;
${commonCode}
// eslint-disable-next-line import/no-default-export
export default resolved;\n`;
  }

  if (path.extname(env.coconfigPath) === '.ts') {
    // Target is JS, source is typescript (requires ts-node)
    return `${header}
require('ts-node').register();
const configModule = require('${modulePath}');
${commonCode}
module.exports = resolved;\n`;
  }
  // Target is JS, source is JS
  return `${header}
const configModule = require('${modulePath}');
${commonCode}
module.exports = resolved;\n`;
}
